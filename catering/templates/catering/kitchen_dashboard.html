{% extends 'kitchen/base.html' %} {% block content %}

<div class="max-w-8xl mx-auto pb-12">
 <!-- Header Section -->

 <!-- Header Section -->
 <div
  class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
  <div>
   <h2 class="text-4xl font-extrabold text-slate-900 tracking-tight">
    Catering Command Center
   </h2>
   <div class="flex items-center gap-2 mt-2">
    <span class="relative flex h-3 w-3">
     <span
      class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
     <span
      class="relative inline-flex rounded-full h-3 w-3 bg-slate-900"></span>
    </span>
    <p class="text-slate-500 font-medium">Live Event Stream</p>
   </div>
  </div>

  <div class="hidden" id="sync-indicator"></div>
 </div>

 <!-- Active Orders Grid -->
 <div
  id="orders-grid"
  class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
  <!-- Orders injected via JS -->
 </div>

 <!-- No Orders State -->
 <div
  id="no-orders"
  class="hidden col-span-full flex flex-col items-center justify-center py-24 bg-white rounded-[2rem] border-2 border-dashed border-slate-200 text-center shadow-sm">
  <div class="bg-slate-50 p-6 rounded-full mb-6 relative">
   <svg
    class="w-16 h-16 text-slate-400 relative z-10"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24">
    <path
     stroke-linecap="round"
     stroke-linejoin="round"
     stroke-width="2"
     d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
   </svg>
   <div
    class="absolute inset-0 bg-slate-200 rounded-full blur-xl opacity-20"></div>
  </div>
  <h3 class="text-2xl font-black text-slate-900 mb-2 tracking-tight">
   No Active Events
  </h3>
  <p class="text-slate-500 max-w-sm mx-auto text-lg">
   Your catering queue is currently empty. Upcoming events will appear here
   automatically.
  </p>
 </div>
</div>

<script>
 function fetchOrders() {
  // console.log("Fetching catering orders...");
  fetch("/api/catering/kitchen/active-orders/")
   .then((response) => response.json())
   .then((data) => {
    renderOrders(data.orders);
   })
   .catch((error) => console.error("Error fetching orders:", error));
 }

 function renderOrders(orders) {
  const grid = document.getElementById("orders-grid");
  const noOrders = document.getElementById("no-orders");

  if (!orders || orders.length === 0) {
   grid.innerHTML = "";
   noOrders.classList.remove("hidden");
   return;
  }

  noOrders.classList.add("hidden");

  const statusColors = {
   PENDING: "bg-amber-100 text-amber-800 ring-amber-600/20",
   CONFIRMED: "bg-indigo-100 text-indigo-800 ring-indigo-600/20",
   PREPARING: "bg-purple-100 text-purple-800 ring-purple-600/20",
   READY: "bg-emerald-100 text-emerald-800 ring-emerald-600/20",
  };

  const html = orders
   .map(
    (order, index) => `
            <div class="group bg-white rounded-[1.5rem] shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 overflow-hidden border border-slate-100 flex flex-col h-full animate-fade-in-up" style="animation-delay: ${index * 100}ms">
                
                <!-- Card Header -->
                <div class="px-6 py-4 bg-gradient-to-br from-slate-50 to-white border-b border-slate-100 flex justify-between items-start relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-0.5">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Order</span>
                            <h3 class="text-sm font-black text-slate-800 tracking-tight">#${order.order_id}</h3>
                        </div>
                        <span class="text-[10px] font-medium text-slate-500 flex items-center">
                             <svg class="w-3 h-3 mr-1 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             ${order.timesince} ago
                        </span>
                    </div>
                    <span class="relative z-20 flex-shrink-0 ml-4 px-2 py-0.5 rounded-full text-[10px] font-bold ring-1 ring-inset shadow-sm uppercase tracking-wide whitespace-nowrap ${statusColors[order.status] || "bg-gray-100 text-gray-800"}">
                        ${order.status_display}
                    </span>
                    
                    <!-- Decorative BG Element -->
                     <svg class="absolute top-0 right-0 w-20 h-20 text-slate-50 transform translate-x-1/3 -translate-y-1/3 pointer-events-none z-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                </div>

                <!-- Event Ticket Info -->
                <div class="p-6 pb-2">
                    <div class="bg-indigo-50/50 rounded-xl p-3 border border-indigo-100/50 flex flex-col gap-2">
                         <div class="flex items-center justify-between pb-2 border-b border-indigo-100/50 border-dashed">
                             <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Event Details</span>
                             <span class="text-[10px] font-bold text-indigo-800 bg-indigo-100 px-1.5 py-0.5 rounded text-right truncate max-w-[120px]">${order.event_type}</span>
                         </div>
                         <div class="flex justify-between items-end">
                             <div>
                                 <div class="text-lg font-black text-slate-800 leading-none mb-0.5">${order.event_time}</div>
                                 <div class="text-xs font-semibold text-slate-500">${order.event_date}</div>
                             </div>
                             <div class="text-right">
                                 <div class="text-sm font-bold text-slate-800 flex items-center justify-end">
                                     <svg class="w-4 h-4 mr-1 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                     ${order.guest_count}
                                 </div>
                                 <div class="text-[10px] font-semibold text-slate-400 uppercase tracking-wide">Guests</div>
                             </div>
                         </div>
                    </div>
                    
                    <div class="mt-3 flex items-center text-xs text-slate-500 font-medium px-1">
                        <svg class="w-3.5 h-3.5 mr-1.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="truncate">${order.location || "No location provided"}</span>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="px-6 py-3 flex-grow bg-slate-50/50">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-100 pb-1">Menu Preview</h4>
                    <ul class="space-y-2">
                        ${order.items
                         .slice(0, 1)
                         .map(
                          (item) => `
                            <li class="flex justify-between items-start group/item">
                                <div class="flex-1 pr-2">
                                    <div class="flex items-center gap-2 mb-0.5">
                                         <span class="font-bold text-slate-800 text-sm leading-snug group-hover/item:text-indigo-600 transition-colors line-clamp-1">${item.name}</span>
                                    </div>
                                    ${item.description ? `<p class="text-[10px] text-slate-400 leading-tight line-clamp-1">${item.description}</p>` : ""}
                                </div>
                                <span class="flex-shrink-0 bg-slate-800 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">x${item.quantity}</span>
                            </li>
                        `,
                         )
                         .join("")}
                         ${
                          order.items.length > 1
                           ? `
                            <li class="pt-1 text-center">
                                <span class="text-[10px] font-bold text-indigo-500 hover:text-indigo-600">+ ${order.items.length - 1} more items...</span>
                            </li>
                         `
                           : ""
                         }
                    </ul>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-white border-t border-slate-100 mt-auto flex flex-col gap-3">
                    <a href="${order.detail_url}" class="w-full flex items-center justify-center bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-lg hover:shadow-indigo-200 px-4 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 group/btn">
                         View Details
                         <svg class="w-4 h-4 ml-2 group-hover/btn:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </a>
                    
                    <div class="flex justify-between items-center px-1">
                         <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Value</span>
                         <span class="text-base font-black text-emerald-600">AED ${order.total_amount.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `,
   )
   .join("");

  grid.innerHTML = html;
 }

 // Initial Fetch
 fetchOrders();

 // Poll every 10s
 setInterval(fetchOrders, 10000);
</script>

<style>
 @keyframes fadeInUp {
  from {
   opacity: 0;
   transform: translateY(15px);
  }
  to {
   opacity: 1;
   transform: translateY(0);
  }
 }
 .animate-fade-in-up {
  animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
 }
</style>

{% endblock %}
